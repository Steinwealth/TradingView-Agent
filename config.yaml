# TradingView Agent Configuration
# Declarative configuration for strategies, accounts, and routing
# Secrets loaded from environment variables (never commit secrets!)

version: "3.6"

# ============================================
# GENERAL SETTINGS
# ============================================

general:
  local_timezone: America/Los_Angeles     # Local timezone for scheduling & display (auto DST aware)
  capital_allocation_pct: 80.0            # % of equity allocated per trade (80/20 deploy/reserve)
  max_position_allocation_pct: 100.0      # % of the capital allocation permitted per individual signal
  min_contract_buffer_pct: 30.0           # Extra cushion applied to min contract wallet requirements
  disable_entries_fri_sun: true            # Disable entries Fri 4am PT - Mon 1am PT (enables scale-to-zero)
  demo_starting_balance: 2000.0           # Starting balance for DEMO mode accounts (USD). Change this to adjust demo account starting balance globally.

# ============================================
# HOLIDAY / TRADING WINDOW GUARD (OPTIONAL)
# ============================================
calendar:
  enabled: true
  timezone: America/New_York              # Evaluate holiday windows in ET
  pre_holiday_block_hours: 24             # Block new entries this many hours BEFORE a holiday (00:00 ET)
  post_holiday_block_hours: 24            # Continue blocking this many hours AFTER holiday end (23:59:59 ET)
  holidays: []                            # Populate with YYYY-MM-DD (ET) from your canonical holiday list

# ============================================
# EXIT SETTINGS PRESETS (Timeframe-Based)
# ============================================
# Timeframe-based exit settings presets for easy switching between 5m, 1h, 4h
# Strategies can use these presets by setting: exit_settings_preset: "1h"
# Or override with custom exit_settings block
# 
# To switch timeframes: Just change the strategy's timeframe and exit_settings_preset

exit_settings_presets:
  # 5-Minute Preset (Default for 5m strategies)
  5m:
    # RSI Exit
    use_rsi_exit: true
    rsi_length: 3                       # RSI calculation period
    rsi_exit_long: 30.0                 # Close long when RSI <= this
    rsi_exit_short: 74.0                # Close short when RSI >= this
    rsi_exit_activation_pct: 0.7        # RSI exit only activates after this profit %
    
    # Breakeven Protection
    use_breakeven: true
    breakeven_trigger: 1.5              # Activate breakeven at this profit %
    breakeven_level: 0.3                # Lock profit at this %
    
    # 6-Hour Persistent Breakeven
    use_6hour_breakeven: false          # DISABLED
    breakeven_6h_min_pct: 0.1
    breakeven_6h_max_pct: 0.5
    
    # Trailing Stop
    use_trailing: true
    trailing_trigger: 2.0               # Activate trailing at this profit %
    trailing_dist: 1.0                  # Trail distance %
    
    # Stop Loss / Take Profit
    stop_mode: "ATR-Based"
    stop_loss_pct: 1.5                  # Fallback stop loss %
    take_profit_pct: 4.0                # Take profit %
    atr_length: 8                       # ATR calculation period
    atr_mult: 13.0                      # ATR multiplier
    
    # EOD Auto-Close
    auto_close_eod: false
    eod_close_time: "15:45"             # ET time (HH:MM format)

  # 1-Hour Preset (Default for 1h strategies)
  1h:
    # RSI Exit
    use_rsi_exit: true
    rsi_length: 3                       # RSI calculation period
    rsi_exit_long: 40.0                 # Close long when RSI <= this (v14 1H BTC preset)
    rsi_exit_short: 60.0                # Close short when RSI >= this (v14 1H BTC preset)
    rsi_exit_activation_pct: 0.1        # RSI exit only activates after this profit % (v14 1H preset)
    
    # Breakeven Protection
    use_breakeven: true
    breakeven_trigger: 1.5              # Activate breakeven at this profit %
    breakeven_level: 0.3                # Lock profit at this %
    
    # 6-Hour Persistent Breakeven
    use_6hour_breakeven: false          # DISABLED
    breakeven_6h_min_pct: 0.1
    breakeven_6h_max_pct: 0.5
    
    # Trailing Stop
    use_trailing: true
    trailing_trigger: 2.0               # Activate trailing at this profit %
    trailing_dist: 1.0                  # Trail distance %
    
    # Stop Loss / Take Profit
    stop_mode: "ATR-Based"
    stop_loss_pct: 1.5                  # Fallback stop loss %
    take_profit_pct: 4.0                # Take profit %
    atr_length: 8                       # ATR calculation period
    atr_mult: 13.0                      # ATR multiplier
    
    # EOD Auto-Close
    auto_close_eod: false
    eod_close_time: "15:45"             # ET time (HH:MM format)

  # 4-Hour Preset (Default for 4h strategies)
  4h:
    # RSI Exit
    use_rsi_exit: true
    rsi_length: 14                      # RSI calculation period (typical for 4h)
    rsi_exit_long: 30.0                 # Close long when RSI <= this
    rsi_exit_short: 70.0                # Close short when RSI >= this
    rsi_exit_activation_pct: 0.5        # RSI exit only activates after this profit %
    
    # Breakeven Protection
    use_breakeven: true
    breakeven_trigger: 2.0              # Activate breakeven at this profit %
    breakeven_level: 0.5                # Lock profit at this %
    
    # 6-Hour Persistent Breakeven
    use_6hour_breakeven: false          # DISABLED
    breakeven_6h_min_pct: 0.1
    breakeven_6h_max_pct: 0.5
    
    # Trailing Stop
    use_trailing: true
    trailing_trigger: 3.0               # Activate trailing at this profit %
    trailing_dist: 1.5                  # Trail distance %
    
    # Stop Loss / Take Profit
    stop_mode: "ATR-Based"
    stop_loss_pct: 2.0                  # Fallback stop loss %
    take_profit_pct: 5.0                # Take profit %
    atr_length: 14                      # ATR calculation period
    atr_mult: 2.0                       # ATR multiplier
    
    # EOD Auto-Close
    auto_close_eod: false
    eod_close_time: "15:45"             # ET time (HH:MM format)

# ============================================
# TRADINGVIEW STRATEGIES
# ============================================
# Define strategies that send alerts to the Agent
# Each strategy has a unique ID and webhook path
# 
# To use timeframe presets: Set exit_settings_preset: "1h" (or "5m", "4h")
# To override: Use custom exit_settings block instead
# 
# Example:
#   - id: my-strategy
#     timeframe: 1h
#     exit_settings_preset: "1h"  # Uses 1h preset from above
#     # OR use custom exit_settings: { ... }

strategies:
  
  # Strategy 1: Easy Ichimoku Coinbase BTC 5m (HISTORICAL - Disabled for new trades)
  # NOTE: Kept for historical data tracking. All future trading migrated to 1h strategies.
  - id: ichimoku-coinbase-btc-5m
    name: Easy Ichimoku Coinbase BTC 5m
    enabled: false  # Disabled - migrated to 1h
    webhook_path: /webhook/ichimoku-coinbase-btc-5m
    data_symbol: COINBASE:BIPZ2030        # TradingView chart symbol
    timeframe: 5m
    
    execution:
      product_id: BIP-CBSE                # Coinbase product ID (nano BTC perp)
      side_map:
        buy: BUY
        sell: SELL
        exit: CLOSE
    
    sizing:
      capital_alloc_pct: 0.80             # Use 80% of equity (80/20 deploy/reserve)
      leverage: 1                         # Default leverage (overridden per-account)
      min_qty: 0.01                       # Min 0.01 BTC = 1 nano contract
      round_step: 0.01                    # Round to 0.01 BTC
    
    risk:
      max_margin_pct: 0.70                # Never consume >70% margin
      max_pos_contracts: 50               # Max 50 contracts (0.5 BTC)
      stop_policy:
        type: fixed_pct                   # or "atr"
        value: 1.3                        # 1.3% stop loss
      tp_policy:
        type: fixed_pct
        value: 5.5                        # 5.5% take profit
    
    # Agent-level exit monitoring settings (v14 Ichimoku preset - synced with v13/v14 5m ETH preset)
    exit_settings:
      # RSI Exit
      use_rsi_exit: true
      rsi_length: 3                       # RSI calculation period
      rsi_exit_long: 30.0                 # Close long when RSI <= this
      rsi_exit_short: 74.0                # Close short when RSI >= this
      rsi_exit_activation_pct: 0.7        # RSI exit only activates after this profit %
      
      # Breakeven Protection (v13 preset: 1.5% → 0.3%)
      use_breakeven: true
      breakeven_trigger: 1.5              # Activate breakeven at this profit %
      breakeven_level: 0.3                # Lock profit at this % (v13 preset: 0.3%)
      
      # 6-Hour Persistent Breakeven (Enhanced - Dec 9, 2025)
      use_6hour_breakeven: false          # DISABLED - 6-hour persistent breakeven exit
      breakeven_6h_min_pct: 0.1           # Minimum P&L % to exit (+0.1%)
      breakeven_6h_max_pct: 0.5           # Maximum P&L % to exit (+0.5%)
      
      # Trailing Stop (v13 preset: 2.0% trigger @ 1.0% distance)
      use_trailing: true
      trailing_trigger: 2.0               # Activate trailing at this profit % (v13 preset: 2.0%)
      trailing_dist: 1.0                  # Trail distance % (v13 preset: 1.0%)
      
      # Stop Loss / Take Profit (v13 preset: ATR-Based SL 1.5% / TP 4.0%)
      stop_mode: "ATR-Based"              # v13 preset uses ATR-Based
      stop_loss_pct: 1.5                  # v13 preset: 1.5% (fallback)
      take_profit_pct: 4.0                # v13 preset: 4.0%
      atr_length: 8                       # ATR calculation period (v13 preset: len 8)
      atr_mult: 13.0                      # ATR multiplier (v13 preset: mult 13.0)
      
      # EOD Auto-Close
      auto_close_eod: false               # Auto-close at EOD (3:45 PM ET)
      eod_close_time: "15:45"             # ET time (HH:MM format)

  # Strategy 2: Easy Ichimoku Coinbase ETH 5m (HISTORICAL - Disabled for new trades)
  # NOTE: Kept for historical data tracking. All future trading migrated to 1h strategies.
  - id: ichimoku-coinbase-eth-5m
    name: Easy Ichimoku Coinbase ETH 5m
    enabled: false  # Disabled - migrated to 1h
    webhook_path: /webhook/ichimoku-coinbase-eth-5m
    data_symbol: COINBASE:ETPZ2030        # TradingView chart symbol
    timeframe: 5m
    
    execution:
      product_id: ETP-CBSE                # Coinbase product ID (nano ETH perp)
      side_map:
        buy: BUY
        sell: SELL
        exit: CLOSE
    
    sizing:
      capital_alloc_pct: 0.80             # Use 80% of equity (80/20 deploy/reserve)
      leverage: 1                         # Default leverage (overridden per-account)
      min_qty: 0.10                       # Min 0.10 ETH per nano contract
      round_step: 0.10                    # Round to 0.10 ETH
    
    risk:
      max_margin_pct: 0.70                # Never consume >70% margin
      max_pos_contracts: 200              # Max 2 ETH (nano contract units)
      stop_policy:
        type: atr                         # ETH preset uses ATR-based stop
        value: 1.4                        # 1.4% stop loss equivalent
      tp_policy:
        type: fixed_pct
        value: 6.5                        # 6.5% take profit
    
    # Agent-level exit monitoring settings (v14 Ichimoku preset)
    exit_settings:
      # RSI Exit
      use_rsi_exit: true
      rsi_length: 9                       # ETH preset: 9
      rsi_exit_long: 25.0                 # ETH preset: 25.0
      rsi_exit_short: 65.0                # ETH preset: 65.0
      rsi_exit_activation_pct: 0.2        # ETH preset: 0.2%
      
      # Breakeven Protection (v13 preset: 1.5% → 0.5%)
      use_breakeven: true
      breakeven_trigger: 1.5               # ETH preset: 1.5%
      breakeven_level: 0.5                 # ETH preset: 0.5% (v13 preset)
      
      # 6-Hour Persistent Breakeven (Enhanced - Dec 9, 2025)
      use_6hour_breakeven: false          # DISABLED - 6-hour persistent breakeven exit
      breakeven_6h_min_pct: 0.1           # Minimum P&L % to exit (+0.1%)
      breakeven_6h_max_pct: 0.5           # Maximum P&L % to exit (+0.5%)
      
      # Trailing Stop (v13 preset: 1.5% trigger @ 1.3% distance)
      use_trailing: true
      trailing_trigger: 1.5               # ETH preset: 1.5% (v13 preset)
      trailing_dist: 1.3                  # ETH preset: 1.3% (v13 preset)
      
      # Stop Loss / Take Profit (ETH preset: ATR Stop len 2, mult 10)
      stop_mode: "ATR-Based"
      stop_loss_pct: 1.4                  # ETH preset: 1.4% (fallback)
      take_profit_pct: 4.0                # ETH preset: 4.0%
      atr_length: 2                       # ETH preset: 2 (ATR Length)
      atr_mult: 10.0                      # ETH preset: 10.0 (ATR Multiplier)
      
      # EOD Auto-Close
      auto_close_eod: false
      eod_close_time: "15:45"

  # Strategy 3: Easy Ichimoku Coinbase SOL 5m (DISABLED - Migrated to 1h)
  # NOTE: Kept for historical data tracking. Exit settings preserved for later use.
  - id: ichimoku-coinbase-sol-5m
    name: Easy Ichimoku Coinbase SOL 5m
    enabled: false  # Disabled - migrated to 1h (5m exit settings preserved)
    webhook_path: /webhook/ichimoku-coinbase-sol-5m
    data_symbol: COINBASE:SLPZ2030        # TradingView chart symbol
    timeframe: 5m
    
    execution:
      product_id: SLP-CBSE                # Coinbase product ID for SOL nano perp
      side_map:
        buy: BUY
        sell: SELL
        exit: CLOSE
    
    sizing:
      capital_alloc_pct: 0.80             # Use 80% of equity (80/20 deploy/reserve)
      leverage: 1                         # Default leverage (overridden per-account)
      min_qty: 5.0                        # 5 SOL per nano contract
      round_step: 5.0
    
    risk:
      max_margin_pct: 0.70
      max_pos_contracts: 500
      stop_policy:
        type: atr
        value: 2.5
      tp_policy:
        type: fixed_pct
        value: 7.0
    
    # Agent-level exit monitoring settings (Updated SOL 5min preset)
    exit_settings:
      # RSI Exit
      use_rsi_exit: true
      rsi_length: 5                       # SOL preset: 5
      rsi_exit_long: 20.0                 # SOL preset: 20.0 (Long Exit at RSI 20)
      rsi_exit_short: 80.0                # SOL preset: 80.0 (Short Exit at RSI 80)
      rsi_exit_activation_pct: 0.3         # SOL preset: 0.3% (Activation %)
      
      # Breakeven Protection (SOL preset: 3.5% → 1.0%)
      use_breakeven: true
      breakeven_trigger: 3.5               # SOL preset: 3.5% (Trigger %)
      breakeven_level: 1.0                 # SOL preset: 1.0% (Lock %)
      
      # 6-Hour Persistent Breakeven (Enhanced - Dec 9, 2025)
      use_6hour_breakeven: false          # DISABLED - 6-hour persistent breakeven exit
      breakeven_6h_min_pct: 0.1           # Minimum P&L % to exit (+0.1%)
      breakeven_6h_max_pct: 0.5           # Maximum P&L % to exit (+0.5%)
      
      # Trailing Stop (SOL preset: 4.0% trigger @ 2.0% distance)
      use_trailing: true
      trailing_trigger: 4.0                # SOL preset: 4.0% (Trigger %)
      trailing_dist: 2.0                    # SOL preset: 2.0% (Distance %)
      
      # Stop Loss / Take Profit (SOL preset: ATR Stop len 2, mult 12)
      stop_mode: "ATR-Based"
      stop_loss_pct: 2.5                  # SOL preset: 2.5% (Stop Loss %)
      take_profit_pct: 7.5                # SOL preset: 7.5% (Take Profit %)
      atr_length: 2                       # SOL preset: 2 (ATR Length)
      atr_mult: 12.0                      # SOL preset: 12.0 (ATR Multiplier)
      
      # EOD Auto-Close
      auto_close_eod: false
      eod_close_time: "15:45"

  # Strategy 4: Easy Ichimoku Coinbase XRP 5m (DISABLED - Migrated to 1h)
  # NOTE: Kept for historical data tracking. Exit settings preserved for later use.
  - id: ichimoku-coinbase-xrp-5m
    name: Easy Ichimoku Coinbase XRP 5m
    enabled: false  # Disabled - migrated to 1h (5m exit settings preserved)
    webhook_path: /webhook/ichimoku-coinbase-xrp-5m
    data_symbol: COINBASE:XPPZ2030        # TradingView chart symbol
    timeframe: 5m
    
    execution:
      product_id: XPP-CBSE                # Coinbase product ID for XRP nano perp
      side_map:
        buy: BUY
        sell: SELL
        exit: CLOSE
    
    sizing:
      capital_alloc_pct: 0.80             # Use 80% of equity (80/20 deploy/reserve)
      leverage: 1
      min_qty: 500.0                      # 500 XRP per nano contract
      round_step: 500.0
    
    risk:
      max_margin_pct: 0.70
      max_pos_contracts: 200              # 200 nano contracts = 100k XRP (~$45k notional)
      stop_policy:
        type: atr
        value: 1.2
      tp_policy:
        type: fixed_pct
        value: 7.5
    
    # Agent-level exit monitoring settings (v14 Ichimoku preset)
    exit_settings:
      # RSI Exit (v13 preset: RSI 25/75)
      use_rsi_exit: true
      rsi_length: 7                       # XRP preset: 7
      rsi_exit_long: 25.0                 # XRP preset: 25.0 (v13 preset: 25)
      rsi_exit_short: 75.0                # XRP preset: 75.0 (v13 preset: 75)
      rsi_exit_activation_pct: 0.1        # XRP preset: 0.1%
      
      # Breakeven Protection (v13 preset: 1.5% → 0.5%)
      use_breakeven: true
      breakeven_trigger: 1.5               # XRP preset: 1.5%
      breakeven_level: 0.5                 # XRP preset: 0.5% (v13 preset)
      
      # 6-Hour Persistent Breakeven (Enhanced - Dec 9, 2025)
      use_6hour_breakeven: false          # DISABLED - 6-hour persistent breakeven exit
      breakeven_6h_min_pct: 0.1           # Minimum P&L % to exit (+0.1%)
      breakeven_6h_max_pct: 0.5           # Maximum P&L % to exit (+0.5%)
      
      # Trailing Stop (v13 preset: 1.5% trigger @ 0.05% distance)
      use_trailing: true
      trailing_trigger: 1.5                # XRP preset: 1.5% (v13 preset)
      trailing_dist: 0.05                  # XRP preset: 0.05% (v13 preset)
      
      # Stop Loss / Take Profit (v13 preset: ATR-Based SL 1.5% / TP 6.5%)
      stop_mode: "ATR-Based"              # v13 preset uses ATR-Based
      stop_loss_pct: 1.5                  # XRP preset: 1.5% (fallback)
      take_profit_pct: 6.5                # XRP preset: 6.5% (v13 preset: TP 6.5)
      atr_length: 2                       # XRP preset: 2 (v13 preset: ATR len 2)
      atr_mult: 13.0                      # XRP preset: 13.0 (v13 preset: mult 13.0)
      
      # EOD Auto-Close
      auto_close_eod: false
      eod_close_time: "15:45"

  # Strategy 5: Easy Ichimoku Coinbase BTC 1h
  - id: ichimoku-coinbase-btc-1h
    name: Easy Ichimoku Coinbase BTC 1h
    enabled: true
    webhook_path: /webhook/ichimoku-coinbase-btc-1h
    data_symbol: COINBASE:BIPZ2030        # TradingView chart symbol
    timeframe: 1h
    
    execution:
      product_id: BIP-CBSE                # Coinbase product ID (nano BTC perp)
      side_map:
        buy: BUY
        sell: SELL
        exit: CLOSE
    
    sizing:
      capital_alloc_pct: 0.80             # Use 80% of equity (80/20 deploy/reserve)
      leverage: 1                         # Default leverage (overridden per-account)
      min_qty: 0.01                       # Min 0.01 BTC = 1 nano contract
      round_step: 0.01                    # Round to 0.01 BTC
    
    risk:
      max_margin_pct: 0.70                # Never consume >70% margin
      max_pos_contracts: 50               # Max 50 contracts (0.5 BTC)
      stop_policy:
        type: fixed_pct                   # or "atr"
        value: 1.3                        # 1.3% stop loss
      tp_policy:
        type: fixed_pct
        value: 5.5                        # 5.5% take profit
    
    # Agent-level exit monitoring settings (v14 1H BTC preset - EXACT MATCH)
    exit_settings:
      # RSI Exit (v14 1H BTC: 40/60, activation 0.1%)
      use_rsi_exit: true
      rsi_length: 5                       # v14 BTC 1H preset: 5 (RSI filter length)
      rsi_exit_long: 40.0                 # v14 BTC 1H preset: 40.0
      rsi_exit_short: 60.0                # v14 BTC 1H preset: 60.0
      rsi_exit_activation_pct: 0.1        # v14 BTC 1H preset: 0.1%
      
      # Breakeven Protection (v14 1H BTC: 1.5% → 0.5%)
      use_breakeven: true
      breakeven_trigger: 1.5              # v14 BTC 1H preset: 1.5%
      breakeven_level: 0.5                # v14 BTC 1H preset: 0.5%
      
      # 3-Hour Breakeven Exit (Available but disabled by default - will be calibrated later)
      use_3hour_breakeven: false           # DISABLED by default - will be calibrated for v14 preset later
      breakeven_3h_min_profit: 0.3        # Minimum profit % to trigger breakeven (0.3%)
      breakeven_3h_min_pct: 0.02          # Minimum P&L % to exit (0.02%)
      breakeven_3h_max_pct: 0.05          # Maximum P&L % to exit (0.05%)
      
      # 6-Hour Persistent Breakeven (v14 1H BTC: Enabled, 0.3% → 0.4%)
      use_6hour_breakeven: true           # v14 1H preset: ENABLED
      breakeven_6h_min_pct: 0.3           # v14 BTC 1H preset: 0.3%
      breakeven_6h_max_pct: 0.4           # v14 BTC 1H preset: 0.4%
      
      # Trailing Stop (v14 1H BTC: 1.5% trigger @ 0.8% distance)
      use_trailing: true
      trailing_trigger: 1.5               # v14 BTC 1H preset: 1.5%
      trailing_dist: 0.8                  # v14 BTC 1H preset: 0.8%
      
      # Stop Loss / Take Profit (v14 1H BTC: ATR len 4, mult 2.6, TP 4.0%)
      stop_mode: "ATR-Based"
      stop_loss_pct: 1.5                  # v14 BTC 1H preset: 1.5% (fallback)
      take_profit_pct: 4.0                # v14 BTC 1H preset: 4.0%
      atr_length: 4                       # v14 BTC 1H preset: 4
      atr_mult: 2.6                       # v14 BTC 1H preset: 2.6
      
      # EOD Auto-Close
      auto_close_eod: false
      eod_close_time: "15:45"

  # Strategy 6: Easy Ichimoku Coinbase ETH 1h
  - id: ichimoku-coinbase-eth-1h
    name: Easy Ichimoku Coinbase ETH 1h
    enabled: true
    webhook_path: /webhook/ichimoku-coinbase-eth-1h
    data_symbol: COINBASE:ETPZ2030        # TradingView chart symbol
    timeframe: 1h
    
    execution:
      product_id: ETP-CBSE                # Coinbase product ID (nano ETH perp)
      side_map:
        buy: BUY
        sell: SELL
        exit: CLOSE
    
    sizing:
      capital_alloc_pct: 0.80             # Use 80% of equity (80/20 deploy/reserve)
      leverage: 1                         # Default leverage (overridden per-account)
      min_qty: 0.10                       # Min 0.10 ETH per nano contract
      round_step: 0.10                    # Round to 0.10 ETH
    
    risk:
      max_margin_pct: 0.70                # Never consume >70% margin
      max_pos_contracts: 200              # Max 2 ETH (nano contract units)
      stop_policy:
        type: atr                         # ETH preset uses ATR-based stop
        value: 1.4                        # 1.4% stop loss equivalent
      tp_policy:
        type: fixed_pct
        value: 6.5                        # 6.5% take profit
    
    # Agent-level exit monitoring settings (v14 1H ETH preset - EXACT MATCH)
    exit_settings:
      # RSI Exit (v14 1H ETH: 50/50, activation 0.1%)
      use_rsi_exit: true
      rsi_length: 7                       # v14 ETH 1H preset: 7 (RSI filter length)
      rsi_exit_long: 50.0                 # v14 ETH 1H preset: 50.0
      rsi_exit_short: 50.0                # v14 ETH 1H preset: 50.0
      rsi_exit_activation_pct: 0.1        # v14 ETH 1H preset: 0.1%
      
      # Breakeven Protection (v14 1H ETH: 1.6% → 1.1%)
      use_breakeven: true
      breakeven_trigger: 1.6              # v14 ETH 1H preset: 1.6%
      breakeven_level: 1.1                # v14 ETH 1H preset: 1.1%
      
      # 3-Hour Breakeven Exit (Available but disabled by default - will be calibrated later)
      use_3hour_breakeven: false           # DISABLED by default - will be calibrated for v14 preset later
      breakeven_3h_min_profit: 0.3        # Minimum profit % to trigger breakeven (0.3%)
      breakeven_3h_min_pct: 0.02          # Minimum P&L % to exit (0.02%)
      breakeven_3h_max_pct: 0.05          # Maximum P&L % to exit (0.05%)
      
      # 6-Hour Persistent Breakeven (v14 1H ETH: Enabled, 0.4% → 0.4%)
      # UPDATED Jan 13, 2026: Agent now detects when price ENTERS the range (not just when currently in range)
      # This catches cases where price moves through the range during a bar but closes outside
      use_6hour_breakeven: true           # v14 1H preset: ENABLED
      breakeven_6h_min_pct: 0.4           # v14 ETH 1H preset: 0.4% (unleveraged price change)
      breakeven_6h_max_pct: 0.4           # v14 ETH 1H preset: 0.4% (unleveraged price change)
      
      # Trailing Stop (v14 1H ETH: 2.4% trigger @ 0.5% distance)
      use_trailing: true
      trailing_trigger: 2.4               # v14 ETH 1H preset: 2.4%
      trailing_dist: 0.5                  # v14 ETH 1H preset: 0.5%
      
      # Stop Loss / Take Profit (v14 1H ETH: ATR len 3, mult 6.0, TP 3.5%)
      stop_mode: "ATR-Based"
      stop_loss_pct: 1.4                  # v14 ETH 1H preset: 1.4% (fallback)
      take_profit_pct: 3.5                # v14 ETH 1H preset: 3.5%
      atr_length: 3                       # v14 ETH 1H preset: 3
      atr_mult: 6.0                       # v14 ETH 1H preset: 6.0
      
      # EOD Auto-Close
      auto_close_eod: false
      eod_close_time: "15:45"

  # Strategy 7: Easy Ichimoku Coinbase SOL 1h (ACTIVE - Using v14 1H preset exit settings)
  # NOTE: Each symbol has unique v14 1H preset settings, so custom exit_settings required
  - id: ichimoku-coinbase-sol-1h
    name: Easy Ichimoku Coinbase SOL 1h
    enabled: true
    webhook_path: /webhook/ichimoku-coinbase-sol-1h
    data_symbol: COINBASE:SLPZ2030        # TradingView chart symbol
    timeframe: 1h
    
    execution:
      product_id: SLP-CBSE                # Coinbase product ID for SOL nano perp
      side_map:
        buy: BUY
        sell: SELL
        exit: CLOSE
    
    sizing:
      capital_alloc_pct: 0.80             # Use 80% of equity (80/20 deploy/reserve)
      leverage: 1                         # Default leverage (overridden per-account)
      min_qty: 5.0                        # 5 SOL per nano contract
      round_step: 5.0
    
    risk:
      max_margin_pct: 0.70
      max_pos_contracts: 500
      stop_policy:
        type: atr
        value: 2.5
      tp_policy:
        type: fixed_pct
        value: 7.0
    
    # Agent-level exit monitoring settings (v14 1H SOL preset - EXACT MATCH)
    # NOTE: Each symbol has unique v14 1H preset settings, so custom exit_settings required
    exit_settings:
      # RSI Exit (v14 1H SOL: 30/77, activation 0.1%)
      use_rsi_exit: true
      rsi_length: 3                       # v14 SOL 1H preset: 3 (RSI filter length)
      rsi_exit_long: 30.0                 # v14 SOL 1H preset: 30.0
      rsi_exit_short: 77.0                # v14 SOL 1H preset: 77.0
      rsi_exit_activation_pct: 0.1        # v14 SOL 1H preset: 0.1%
      
      # Breakeven Protection (v14 1H SOL: 1.8% → 1.5%)
      use_breakeven: true
      breakeven_trigger: 1.8              # v14 SOL 1H preset: 1.8%
      breakeven_level: 1.5                # v14 SOL 1H preset: 1.5%
      
      # 3-Hour Breakeven Exit (Available but disabled by default - will be calibrated later)
      use_3hour_breakeven: false           # DISABLED by default - will be calibrated for v14 preset later
      breakeven_3h_min_profit: 0.3        # Minimum profit % to trigger breakeven (0.3%)
      breakeven_3h_min_pct: 0.02          # Minimum P&L % to exit (0.02%)
      breakeven_3h_max_pct: 0.05          # Maximum P&L % to exit (0.05%)
      
      # 6-Hour Persistent Breakeven (v14 1H SOL: Enabled, 0.4% → 0.5%)
      use_6hour_breakeven: true           # v14 1H preset: ENABLED
      breakeven_6h_min_pct: 0.4           # v14 SOL 1H preset: 0.4%
      breakeven_6h_max_pct: 0.5           # v14 SOL 1H preset: 0.5%
      
      # Trailing Stop (v14 1H SOL: 1.8% trigger @ 1.2% distance)
      use_trailing: true
      trailing_trigger: 1.8               # v14 SOL 1H preset: 1.8%
      trailing_dist: 1.2                  # v14 SOL 1H preset: 1.2%
      
      # Stop Loss / Take Profit (v14 1H SOL: ATR len 2, mult 3.4, TP 7.0%)
      stop_mode: "ATR-Based"
      stop_loss_pct: 2.0                  # v14 SOL 1H preset: 2.0% (fallback)
      take_profit_pct: 7.0                # v14 SOL 1H preset: 7.0%
      atr_length: 2                       # v14 SOL 1H preset: 2
      atr_mult: 3.4                       # v14 SOL 1H preset: 3.4
      
      # EOD Auto-Close
      auto_close_eod: false
      eod_close_time: "15:45"

  # Strategy 8: Easy Ichimoku Coinbase XRP 1h (ACTIVE - Using v14 1H preset exit settings)
  # NOTE: XRP 1h preset ready. Using v14 1H preset exit settings.
  - id: ichimoku-coinbase-xrp-1h
    name: Easy Ichimoku Coinbase XRP 1h
    enabled: true  # Enabled - Using v14 1H preset exit settings
    webhook_path: /webhook/ichimoku-coinbase-xrp-1h
    data_symbol: COINBASE:XPPZ2030        # TradingView chart symbol
    timeframe: 1h
    
    execution:
      product_id: XPP-CBSE                # Coinbase product ID for XRP nano perp
      side_map:
        buy: BUY
        sell: SELL
        exit: CLOSE
    
    sizing:
      capital_alloc_pct: 0.80             # Use 80% of equity (80/20 deploy/reserve)
      leverage: 1
      min_qty: 500.0                      # 500 XRP per nano contract
      round_step: 500.0
    
    risk:
      max_margin_pct: 0.70
      max_pos_contracts: 200              # 200 nano contracts = 100k XRP (~$45k notional)
      stop_policy:
        type: atr
        value: 1.2
      tp_policy:
        type: fixed_pct
        value: 7.5
    
    # Agent-level exit monitoring settings (v14 1H XRP preset - EXACT MATCH)
    exit_settings:
      # RSI Exit (v14 1H XRP: 45/55, activation 0.1%)
      use_rsi_exit: true
      rsi_length: 7                       # v14 XRP 1H preset: 7 (RSI filter length, not exit length)
      rsi_exit_long: 45.0                 # v14 XRP 1H preset: 45.0
      rsi_exit_short: 55.0                # v14 XRP 1H preset: 55.0
      rsi_exit_activation_pct: 0.1        # v14 XRP 1H preset: 0.1%
      
      # Breakeven Protection (v14 1H XRP: 1.5% → 0.8%)
      use_breakeven: true
      breakeven_trigger: 1.5             # v14 XRP 1H preset: 1.5%
      breakeven_level: 0.8                # v14 XRP 1H preset: 0.8%
      
      # 3-Hour Breakeven Exit (Available but disabled by default - will be calibrated later)
      use_3hour_breakeven: false           # DISABLED by default - will be calibrated for v14 preset later
      breakeven_3h_min_profit: 0.3        # Minimum profit % to trigger breakeven (0.3%)
      breakeven_3h_min_pct: 0.02          # Minimum P&L % to exit (0.02%)
      breakeven_3h_max_pct: 0.05          # Maximum P&L % to exit (0.05%)
      
      # 6-Hour Persistent Breakeven (v14 1H XRP: Enabled, 0.3% → 0.4%)
      use_6hour_breakeven: true           # v14 1H preset: ENABLED
      breakeven_6h_min_pct: 0.3           # v14 XRP 1H preset: 0.3%
      breakeven_6h_max_pct: 0.4           # v14 XRP 1H preset: 0.4%
      
      # Trailing Stop (v14 1H XRP: 1.5% trigger @ 1.0% distance)
      use_trailing: true
      trailing_trigger: 1.5               # v14 XRP 1H preset: 1.5%
      trailing_dist: 1.0                  # v14 XRP 1H preset: 1.0%
      
      # Stop Loss / Take Profit (v14 1H XRP: ATR len 6, mult 5.0, TP 4.0%)
      stop_mode: "ATR-Based"
      stop_loss_pct: 1.5                  # v14 XRP 1H preset: 1.5% (fallback)
      take_profit_pct: 4.0                # v14 XRP 1H preset: 4.0%
      atr_length: 6                       # v14 XRP 1H preset: 6 (ATR Length)
      atr_mult: 5.0                       # v14 XRP 1H preset: 5.0 (ATR Multiplier)
      
      # EOD Auto-Close
      auto_close_eod: false
      eod_close_time: "15:45"

  # Strategy 3: Easy Ichimoku Binance 5m
  - id: ichimoku-binance-5m
    name: Easy Ichimoku Binance 5m
    webhook_path: /webhook/ichimoku-binance-5m
    data_symbol: BINANCE:BTCUSDTPERP
    timeframe: 5m
    
    execution:
      product_id: BTCUSDT                 # Binance symbol
      side_map:
        buy: BUY
        sell: SELL
        exit: CLOSE
    
    sizing:
      capital_alloc_pct: 0.80             # Use 80% of equity (80/20 deploy/reserve)
      leverage: 1
      min_qty: 0.001                      # Binance min 0.001 BTC
      round_step: 0.001
    
    risk:
      max_margin_pct: 0.70
      max_pos_contracts: 10
      stop_policy:
        type: fixed_pct
        value: 1.3
      tp_policy:
        type: fixed_pct
        value: 5.5
  
  # Strategy 3: Easy MegaCryptoBot (Future)
  - id: megacryptobot-15m
    name: Easy MegaCryptoBot 15m
    webhook_path: /webhook/megacryptobot-15m
    data_symbol: COINBASE:BTCUSDC.P
    timeframe: 15m
    enabled: false                        # Disabled for now
    
    execution:
      product_id: BTCUSDC.P
      side_map:
        buy: BUY
        sell: SELL
        exit: CLOSE
    
    sizing:
      capital_alloc_pct: 0.80             # Use 80% of equity (80/20 deploy/reserve)
      leverage: 1
      min_qty: 0.01
      round_step: 0.01

# ============================================
# BROKER ACCOUNTS
# ============================================
# Define broker accounts that execute trades
# Each account listens to one or more strategies
# Secrets loaded from ${ENV_VAR} environment variables

accounts:
  
  # Account 1: Coinbase USA nano PERPs - Cooperative 3 × 33% partitions @ 3x
  - id: coinbase-main
    broker: coinbase_futures
    enabled: true
    mode: DEMO                            # LIVE mode for real trading
    label: Coinbase Main Account
    
    # Strategy IDs this account listens to (required for validation)
    # NOTE: Mixed timeframe - BTC/ETH on 1h charts, SOL/XRP still on 5m charts
    strategy_ids:
      # 1h strategies (ACTIVE - All symbols using v14 1H preset exit settings)
      - ichimoku-coinbase-btc-1h
      - ichimoku-coinbase-eth-1h
      - ichimoku-coinbase-sol-1h
      - ichimoku-coinbase-xrp-1h
      # 5m strategies (HISTORICAL - Disabled, exit settings preserved for later use)
      - ichimoku-coinbase-btc-5m
      - ichimoku-coinbase-eth-5m
      - ichimoku-coinbase-sol-5m
      - ichimoku-coinbase-xrp-5m
    
    # API credentials (from Google Secret Manager)
    # Note: Coinbase Cloud API (CDP) format - may need broker code update
    api_key: ${COINBASE_API_KEY_1}        # API Key Name (organizations/...)
    api_secret: ${COINBASE_PRIVATE_KEY_1}  # EC Private Key (PEM format)
    
    # Virtual Partitions (V3.6)
    partition_mode: enabled
    partition_split: "33/33/33"            # Three partitions @ 33% each
    partition_style: cooperative            # cooperative = partitions rebalance to maintain allocation percentages
    
    partitions:
      - id: "33%-1-3x"
        enabled: true
        allocation_pct: 33.33              # 33.33% of account balance
        leverage: 3
        min_balance_usd: 100.0
        strategy_ids:
          # 1h strategies (All symbols using v14 1H preset exit settings)
          - ichimoku-coinbase-btc-1h
          - ichimoku-coinbase-eth-1h
          - ichimoku-coinbase-sol-1h
          - ichimoku-coinbase-xrp-1h

      - id: "33%-2-3x"
        enabled: true
        allocation_pct: 33.33
        leverage: 3
        min_balance_usd: 100.0
        strategy_ids:
          # 1h strategies (All symbols using v14 1H preset exit settings)
          - ichimoku-coinbase-btc-1h
          - ichimoku-coinbase-eth-1h
          - ichimoku-coinbase-sol-1h
          - ichimoku-coinbase-xrp-1h

      - id: "33%-3-3x"
        enabled: true
        allocation_pct: 33.34              # 33.34% to total 100% (rounding)
        leverage: 3
        min_balance_usd: 100.0
        strategy_ids:
          # 1h strategies (All symbols using v14 1H preset exit settings)
          - ichimoku-coinbase-btc-1h
          - ichimoku-coinbase-eth-1h
          - ichimoku-coinbase-sol-1h
          - ichimoku-coinbase-xrp-1h
    
    # Risk settings (applies to all partitions)
    risk:
      max_margin_pct: 0.70
      max_daily_loss_pct: 10.0
      margin_mode: ISOLATED
  
  # Account 3: Binance BTCUSDT.P 1x (Month 2+)
  - id: binance-usdt-1x
    broker: binance_futures
    enabled: false                        # Enable Month 2+
    mode: DEMO
    label: Binance BTCUSDT 1x
    
    strategy_ids:
      - ichimoku-binance-5m               # Binance strategy
    
    leverage: 1
    
    api_key: ${BINANCE_API_KEY_1}
    api_secret: ${BINANCE_API_SECRET_1}
    
    risk:
      max_margin_pct: 0.70
      max_daily_loss_pct: 10.0
      margin_mode: ISOLATED
  
  # Account 4: Binance BTCUSDT.P 3x (Month 2+)
  - id: binance-usdt-3x
    broker: binance_futures
    enabled: false
    mode: DEMO
    label: Binance BTCUSDT 3x
    
    strategy_ids:
      - ichimoku-binance-5m
    
    leverage: 3
    
    api_key: ${BINANCE_API_KEY_2}
    api_secret: ${BINANCE_API_SECRET_2}
    
    risk:
      max_margin_pct: 0.70
      max_daily_loss_pct: 10.0
      margin_mode: ISOLATED
  
  # Account 5-10: Reserved for future expansion
  # Add more accounts as needed with same structure

# ============================================
# ROUTING RULES (OPTIONAL)
# ============================================
# Fine-grained control over which accounts execute which signals
# If not specified, all enabled accounts listening to strategy will execute

routing:
  
  # Strategy 1: Route Coinbase BTC 1h strategy to partitions (ACTIVE - 1h chart)
  - strategy_id: ichimoku-coinbase-btc-1h
    to_accounts:
      - coinbase-main                     # Main account with BTC/ETH/SOL/XRP partitions
    allow_market: true
    allow_limit: true
  
  # Strategy 2: Route Coinbase ETH 1h strategy to partitions (ACTIVE - 1h chart)
  - strategy_id: ichimoku-coinbase-eth-1h
    to_accounts:
      - coinbase-main
    allow_market: true
    allow_limit: true

  # Strategy 3: Route Coinbase SOL 1h strategy to partitions (ACTIVE - 1h chart, v14 1H preset)
  - strategy_id: ichimoku-coinbase-sol-1h
    to_accounts:
      - coinbase-main
    allow_market: true
    allow_limit: true

  # Strategy 4: Route Coinbase XRP 1h strategy to partitions (ACTIVE - 1h chart, v14 1H preset)
  - strategy_id: ichimoku-coinbase-xrp-1h
    to_accounts:
      - coinbase-main
    allow_market: true
    allow_limit: true

# ============================================
# GLOBAL RISK SETTINGS
# ============================================

risk_management:
  max_total_positions: 10                 # Max positions across all accounts
  max_leverage_global: 5                  # Global leverage cap
  enable_trading: true                    # Enable live trading
  max_commission_rate_pct: 0.04           # Block new entries if fees exceed 0.04% of notional
  
  # ADV Cap (Slip Guard)
  adv_cap:
    enabled: true
    cap_pct: 1.0                          # Max 1% of daily volume
    lookback_days: 7
    min_volume_usd: 100000
  
  # MACD Entry Filters (Dec 2025)
  # Based on analysis showing MACD Histogram is the biggest differentiator for entry quality
  # Winners average +0.82 vs Losers -4.40 (difference +5.22)
  # DISABLED: MACD filtering will be implemented in TradingView strategy level, not Agent level
  # Agent will process all webhook signals as received
  macd_filters:
    enabled: false                        # DISABLED - MACD filtering at TradingView strategy level instead
    # LONG Entry Filter: Block LONG entries when MACD Histogram < 0 (negative)
    # Would block many long-holding losers (average MACD -4.40)
    # Would keep most winners (average MACD +0.82)
    long_block_macd_below: 0.0            # Block LONG if MACD < this value
    
    # SHORT Entry Filter: Block SHORT entries when MACD < -20 (overextended)
    # Would block BTC SHORT trades with MACD -32.28, -57.73
    # Would allow SHORT winners (MACD -0.0002, -1.23)
    short_block_macd_below: -20.0         # Block SHORT if MACD < this value

# ============================================
# TELEGRAM NOTIFICATIONS (OPTIONAL)
# ============================================

telegram:
  enabled: true                           # Set to true to enable
  bot_token: ${TELEGRAM_BOT_TOKEN}        # From @BotFather
  chat_id: ${TELEGRAM_CHAT_ID}            # From @userinfobot

# ============================================
# DEPLOYMENT SETTINGS
# ============================================

deployment:
  environment: production                 # production, staging, development
  gcp_project_id: ${GCP_PROJECT_ID}
  region: us-central1
  webhook_secret: ${WEBHOOK_SECRET}       # For TradingView authentication
  admin_secret: ${ADMIN_SECRET}           # For admin endpoints
  
  # TradingView webhook IPs (for validation)
  allowed_ips:
    - 52.89.214.238
    - 34.212.75.30
    - 54.218.53.128

# ============================================
# MONITORING & LOGGING
# ============================================

monitoring:
  use_firestore: true                     # Enable Firestore for trade logging
  firestore_collection: tradingview_trades
  log_level: INFO                         # DEBUG, INFO, WARNING, ERROR

# ============================================
# CONTRACT EXPIRY MONITORING
# ============================================

contract_expiry:
  
  # Known contract expiry dates
  contracts:
    BIPZ2030:
      expiry_date: "2030-12-31"      # String format required
      warning_days: [30, 10, 3]
      block_entry_days: 10
    
    # Perpetuals have no expiry
    BTCUSDTPERP:
      expiry_date: null
    
    BTCUSDC.P:
      expiry_date: null
    
    BTCUSD.P:
      expiry_date: null

# ============================================
# COINBASE FUTURES SETTINGS
# ============================================
# Position sizing and margin rate settings for Coinbase Futures trading
# These settings control margin rate selection based on entry time

coinbase_futures:
  # All Trades Size to Afterhours: If true, all trades use afterhours margin rates (conservative)
  # If false, uses time-based optimization (see size_trades_with_intraday_rates_6p_10p)
  all_trades_size_to_afterhours: false
  
  # Size Trades with Intraday Rates 6PM-10PM ET:
  # If true, uses time-based margin rate selection:
  #   - Trades received 6:01PM-10:00PM ET: Use INTRADAY margin rates (lower, 100% safe window)
  #   - Trades received 10:01PM ET-6:00PM ET: Use AFTERHOURS margin rates (higher, safe for crossing)
  # If false, uses afterhours rates for all trades (if all_trades_size_to_afterhours is false)
  size_trades_with_intraday_rates_6p_10p: true
  
  # Auto Close Trades Oversized for Afterhours at End of Intraday:
  # If true, checks all open positions 5 minutes before intraday ends (3:55PM ET)
  # and auto-closes positions that cannot afford afterhours margin rates to avoid margin calls
  auto_close_trades_oversized_for_afterhours_at_end_of_intraday: true

